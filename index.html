<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™‚å…‰ä¿®å¾©å¸«ï¼šæœªå¯„å‡ºçš„ä¿¡ (æ•™å¸«ç‰ˆ)</title>
    <style>
        /* --- å­—é«”èˆ‡è®Šæ•¸ --- */
        @font-face {
            font-family: 'Iansui';
            src: url('https://cdn.jsdelivr.net/npm/iansui@3.0.0/data/Iansui-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --serenity: #92A8D1;      /* å¯§éœè— */
            --rose-quartz: #F7CAC9;   /* ç«ç‘°ç²‰ */
            --dark-text: #5a5a5a;
            --light-text: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px 0 rgba(146, 168, 209, 0.25);
            --admin-bg: #f8f9fa;
            --admin-card: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Iansui', 'Zen Maru Gothic', 'Noto Serif TC', serif;
            background: linear-gradient(135deg, var(--rose-quartz) 0%, var(--serenity) 100%);
            color: var(--dark-text);
            height: 100vh; /* å›ºå®šé«˜åº¦ */
            width: 100vw;
            overflow: hidden; /* ç¦æ­¢æ•´å€‹é é¢æ²å‹• */
            transition: background 1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- éŠæˆ²ä¸»ä»‹é¢ --- */
        #game-view {
            width: 100%;
            height: 100%;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            height: 98vh; /* ç›¡é‡ä½”æ»¿è¢å¹•é«˜åº¦ï¼Œå–„ç”¨ç©ºé–“ */
            max-height: 800px; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé¿å…åœ¨å¤§è¢å¹•å¤ªé•· */
            background: var(--glass-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px;
            position: relative;
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            transition: all 0.5s ease;
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ—ä½ˆå±€ */
        }

        /* æ¨™é¡Œèˆ‡ Header */
        header { text-align: center; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px dashed rgba(146, 168, 209, 0.5); flex-shrink: 0; }
        h1 { font-size: 1.4rem; margin: 0; background: linear-gradient(90deg, #92A8D1, #e8a6a8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); font-weight: bold; }

        /* HUD */
        #hud { display: none; justify-content: space-between; align-items: center; margin-bottom: 10px; background: rgba(255,255,255,0.8); padding: 8px 15px; border-radius: 50px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.02); border: 1px solid white; flex-shrink: 0; }
        .stat-label { font-weight: bold; font-size: 1rem; color: var(--serenity); }
        .progress-bar-container { width: 60%; height: 10px; background-color: #f0f0f0; border-radius: 20px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--serenity), var(--rose-quartz)); transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1); }

        /* åœ–ç‰‡ - æ™ºæ…§èª¿æ•´å¤§å° */
        #scene-image { 
            width: 100%; 
            height: 260px; /* é è¨­é«˜åº¦ */
            object-fit: cover; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: none; 
            border: 3px solid white; 
            box-shadow: 0 5px 15px rgba(146, 168, 209, 0.2); 
            transition: transform 0.3s ease, filter 0.5s ease; 
            background-color: #eee;
            flex-shrink: 0; /* ç¦æ­¢åœ–ç‰‡è¢«å£“ç¸®åˆ°çœ‹ä¸è¦‹ï¼Œä½†æœƒé€é Media Query èª¿æ•´ */
        }
        
        /* åŠ‡æƒ…æ–‡å­—å€ - éš±è—å·è»¸ä½†ä¿ç•™æ»‘å‹•åŠŸèƒ½ (è‹¥çœŸçš„æº¢å‡º) */
        #story-content { 
            flex-grow: 1; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜é«˜åº¦ */
            overflow-y: auto; /* å…è¨±å‚ç›´æ²å‹• */
            margin-bottom: 10px;
            padding-right: 5px;
            min-height: 50px; /* æœ€å°é«˜åº¦ */
            
            /* éš±è—å·è»¸æ¨£å¼ (Chrome, Safari, Opera) */
            scrollbar-width: none; 
            -ms-overflow-style: none; 
        }
        
        #story-content::-webkit-scrollbar { 
            display: none; /* éš±è— Chrome/Safari å·è»¸ */
        }

        #story-text { 
            font-size: 1.15rem; 
            line-height: 1.5; /* ç¨å¾®ç¸®å°è¡Œè·ä»¥å®¹ç´æ›´å¤šæ–‡å­— */
            margin: 0;
            white-space: pre-wrap; 
            color: #444; 
        }
        
        /* é¸é …æŒ‰éˆ•å€ - å›ºå®šæ–¼åº•éƒ¨ */
        #choices { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            flex-shrink: 0; 
            padding-bottom: 5px; 
            padding-top: 5px; /* å¢åŠ ä¸Šæ–¹é˜²èª¤è§¸é–“è· */
        }
        
        button { font-family: 'Iansui', serif; padding: 12px 16px; font-size: 1rem; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: white; color: var(--dark-text); box-shadow: 0 2px 4px rgba(146, 168, 209, 0.1); border: 1px solid rgba(255,255,255,0.8); text-align: center; position: relative; overflow: hidden; }
        button:hover { transform: translateY(-2px); background: linear-gradient(90deg, #fff, #fef6f6); }
        .role-btn { text-align: center; border-left: 5px solid var(--serenity); }
        .choice-btn { border-left: 5px solid var(--rose-quartz); }
        .choice-c { border: 2px solid #F3E5AB; background: linear-gradient(to right, #fff, #fffdf5); color: #8B8000; font-weight: bold; }
        .choice-c:hover { box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        .choice-c::before { content: "âœ¨"; margin-right: 8px; display: inline-block; animation: spin 3s infinite linear; }
        .choice-disabled { background: #f0f0f0; color: #aaa; pointer-events: none; opacity: 0.6; filter: grayscale(100%); }

        /* å¼·èª¿æ¨£å¼ */
        .highlight {
            color: #d67f81; 
            font-weight: bold;
            border-bottom: 3px solid var(--rose-quartz); 
            padding-bottom: 2px;
            display: inline-block;
        }

        /* Footer */
        footer { margin-top: 5px; text-align: center; opacity: 0.6; font-size: 0.75rem; flex-shrink: 0; }

        /* å‹•ç•« */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }

        /* Bad End ä¸»é¡Œä¿®æ­£ */
        body.bad-end-theme { background: linear-gradient(135deg, #1a1a1a, #434343); }
        .bad-end-theme #game-container { background: rgba(30, 30, 30, 0.95); color: #ddd; border-color: #555; }
        .bad-end-theme h1, .bad-end-theme .stat-label { color: #aaa; -webkit-text-fill-color: #aaa; }
        .bad-end-theme .progress-bar { background: linear-gradient(90deg, #ff416c, #ff4b1f); }
        
        /* ä¿®æ­£ï¼šBad End çš„å…§æ–‡å¼·åˆ¶ç™½è‰² */
        .bad-end-theme #story-text { color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        
        /* ä¿®æ­£ï¼šBad End çš„æŒ‰éˆ•æ–‡å­—é¡è‰² */
        .bad-end-theme button { background: #e0e0e0; color: #222; border-color: #666; font-weight: bold; }
        .bad-end-theme button:hover { background: #fff; }

        /* True End ä¸»é¡Œ */
        body.true-end-theme { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .true-end-theme #game-container { background: rgba(255, 255, 255, 0.95); border-color: #fda085; }

        /* --- é‡å°ä¸åŒè¢å¹•é«˜åº¦çš„è‡ªå‹•èª¿æ•´ (ç¢ºä¿æ–‡å­—ç©ºé–“) --- */
        
        /* ä¸€èˆ¬ç­†é›»æˆ–å¤§å¹³æ¿ (é«˜åº¦ < 800px) */
        @media (max-height: 800px) {
            #scene-image { height: 200px; } 
            h1 { font-size: 1.3rem; }
            #game-container { padding: 15px; }
        }

        /* çŸ®è¢å¹•æˆ–æ©«æ”¾æ‰‹æ©Ÿ (é«˜åº¦ < 600px) */
        @media (max-height: 600px) {
            #scene-image { height: 140px; margin-bottom: 10px; }
            h1 { font-size: 1.1rem; margin-bottom: 0; }
            button { padding: 8px 12px; font-size: 0.9rem; }
            #hud { margin-bottom: 5px; padding: 5px 15px; }
            header { margin-bottom: 5px; }
            #story-text { font-size: 1rem; }
        }

        /* --- æ•™å¸«å¾Œå° (Admin Panel) --- */
        #admin-btn { position: fixed; bottom: 10px; right: 10px; background: rgba(255,255,255,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s; z-index: 100; border: 2px solid var(--serenity); opacity: 0.5; }
        #admin-btn:hover { transform: rotate(90deg); background: white; opacity: 1; }

        #admin-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--admin-bg); z-index: 200; overflow-y: auto; padding: 20px; }
        #admin-container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .admin-section { margin-bottom: 30px; padding: 15px; background: #f9f9f9; border-radius: 15px; border: 1px solid #eee; }
        .admin-section h3 { margin-bottom: 10px; color: #444; border-left: 5px solid var(--serenity); padding-left: 10px; }
        
        .password-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .admin-input { padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Iansui'; }
        .admin-btn { padding: 8px 15px; background: var(--serenity); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Iansui'; }
        .admin-btn:hover { opacity: 0.9; }
        .admin-btn.danger { background: #d9534f; }
        .admin-btn.secondary { background: #6c757d; }

        .scene-card { display: grid; grid-template-columns: 150px 1fr; gap: 15px; background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .scene-preview { width: 100%; height: 100px; background: #eee; border-radius: 8px; object-fit: cover; border: 2px dashed #ccc; display: flex; justify-content: center; align-items: center; color: #999; font-size: 0.8rem; text-align: center; }
        .scene-info h4 { margin-bottom: 5px; color: var(--serenity); font-size: 1rem; }
        .scene-text { font-size: 0.85rem; color: #666; background: #fdfdfd; padding: 8px; border-radius: 8px; border: 1px solid #f0f0f0; margin-top: 5px; max-height: 80px; overflow-y: auto; }
        
        .file-upload-wrapper { position: relative; margin-top: 5px; }
        
        #login-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 300px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        
        @media (max-width: 768px) {
            .scene-card { grid-template-columns: 1fr; }
            .scene-preview { height: 150px; }
            h1 { font-size: 1.3rem; }
        }

        /* çµå°¾ä¿¡ä»¶æ¨£å¼ */
        .epilogue-text { white-space: normal !important; text-align: center; padding: 20px; background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(247, 202, 201, 0.4)); border-radius: 16px; border: 1px solid white; font-size: 1.1rem; }
    </style>
</head>
<body>

<!-- éŠæˆ²è¦–åœ– -->
<div id="game-view">
    <div id="game-container">
        <header>
            <h1 id="game-title">æ™‚å…‰ä¿®å¾©å¸«ï¼šæœªå¯„å‡ºçš„ä¿¡</h1>
        </header>

        <div id="hud">
            <span id="stat-name" class="stat-label">å¿ƒç†æ•¸å€¼</span>
            <div class="progress-bar-container">
                <div id="stat-bar" class="progress-bar"></div>
            </div>
        </div>

        <!-- åœ–ç‰‡é¡¯ç¤ºå€ -->
        <img id="scene-image" src="" alt="æƒ…å¢ƒåœ–" onerror="handleImageError(this)">

        <!-- æ–‡å­—å…§å®¹å€ -->
        <div id="story-content" class="fade-in">
            <p id="story-text">è¼‰å…¥ä¸­...</p>
        </div>

        <div id="choices"></div>

        <footer>
            <p>Â© ç¤¾æœƒæŠ€å·§èª²ç¨‹æ•™æ</p>
        </footer>
    </div>
</div>

<!-- æ•™å¸«å¾Œå°æŒ‰éˆ• -->
<div id="admin-btn" onclick="openLoginModal()">âš™ï¸</div>

<!-- ç™»å…¥è¦–çª— -->
<div id="login-modal">
    <div class="modal-content">
        <h3 style="margin-bottom:15px; color:var(--dark-text);">æ•™å¸«å¾Œå°ç™»å…¥</h3>
        <input type="password" id="login-password" class="admin-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="width:100%; margin-bottom:15px;">
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="admin-btn secondary" onclick="closeLoginModal()">å–æ¶ˆ</button>
            <button class="admin-btn" onclick="checkLogin()">ç™»å…¥</button>
        </div>
        <p id="login-msg" style="color:#d9534f; font-size:0.9rem; margin-top:10px;"></p>
    </div>
</div>

<!-- æ•™å¸«å¾Œå°ä»‹é¢ -->
<div id="admin-panel">
    <div id="admin-container">
        <div class="admin-header">
            <h2>ğŸ› ï¸ æ•™å¸«å¾Œå°ç®¡ç†ç³»çµ±</h2>
            <button class="admin-btn secondary" onclick="closeAdminPanel()">é€€å‡ºå¾Œå°</button>
        </div>

        <!-- 1. å¯†ç¢¼ç®¡ç† -->
        <div class="admin-section">
            <h3>ğŸ”‘ å¯†ç¢¼ç®¡ç†</h3>
            <div class="password-controls">
                <span>ç›®å‰å¯†ç¢¼ï¼š<strong id="current-pass-display" style="color:var(--serenity)">è®€å–ä¸­...</strong></span>
                <button class="admin-btn secondary" onclick="resetPassword()">é‡è¨­ç‚ºé è¨­ (0000)</button>
            </div>
            <div class="password-controls" style="margin-top:15px; border-top:1px dashed #ddd; padding-top:15px;">
                <input type="text" id="new-password" class="admin-input" placeholder="æ–°å¯†ç¢¼">
                <button class="admin-btn" onclick="changePassword()">æ›´æ”¹å¯†ç¢¼</button>
            </div>
        </div>

        <!-- 2. è³‡æ–™å‚™ä»½ -->
        <div class="admin-section">
            <h3>ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
            <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">æ‚¨å¯ä»¥å°‡ç›®å‰çš„åœ–ç‰‡èˆ‡è¨­å®šåŒ¯å‡ºæˆæª”æ¡ˆï¼Œåœ¨å…¶ä»–é›»è…¦åŒ¯å…¥å³å¯ä½¿ç”¨ã€‚</p>
            <div class="password-controls">
                <button class="admin-btn" onclick="exportData()">åŒ¯å‡ºè¨­å®šæª” (JSON)</button>
                <button class="admin-btn secondary" onclick="document.getElementById('import-file').click()">åŒ¯å…¥è¨­å®šæª”</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(this)">
            </div>
        </div>

        <!-- 3. å¡ç‰‡åœ–ç‰‡ç®¡ç† -->
        <div class="admin-section">
            <h3>ğŸ–¼ï¸ æƒ…å¢ƒå¡ç‰‡åœ–ç‰‡ç®¡ç†</h3>
            <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">è«‹åœ¨æ­¤ä¸Šå‚³æ¯å€‹å ´æ™¯å°æ‡‰çš„åœ–ç‰‡ã€‚ç³»çµ±æœƒè‡ªå‹•å£“ç¸®åœ–ç‰‡ä»¥ç¯€çœç©ºé–“ã€‚</p>
            <div id="scene-list">
                <!-- JS å‹•æ…‹ç”Ÿæˆåˆ—è¡¨ -->
            </div>
        </div>
    </div>
</div>

<script>
    // --- å‚™ç”¨ï¼šSVG ç”¢ç”Ÿå™¨ (ç•¶æ²’åœ–æ™‚é¡¯ç¤º) ---
    const generateFallbackArt = (emoji, text, type = "normal") => {
        let bgGradient = type === "bad" 
            ? `<linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#2c3e50;stop-opacity:1" /><stop offset="100%" style="stop-color:#000000;stop-opacity:1" /></linearGradient>`
            : `<linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#F7CAC9;stop-opacity:1" /><stop offset="100%" style="stop-color:#92A8D1;stop-opacity:1" /></linearGradient>`;
        
        const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="300" viewBox="0 0 600 300">
            <defs>${bgGradient}</defs>
            <rect width="100%" height="100%" fill="url(#grad)"/>
            <text x="50%" y="50%" font-family="sans-serif" font-size="80" text-anchor="middle" dominant-baseline="middle">${emoji}</text>
            <text x="50%" y="85%" font-family="sans-serif" font-size="20" fill="#fff" text-anchor="middle" font-weight="bold">${text}</text>
        </svg>`.trim();
        return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    };

    // --- è³‡æ–™çµæ§‹ ---
    const roles = {
        A: { name: "å¯«éºæ›¸çš„äºº", statName: "çµ•æœ›å€¼" },
        B: { name: "éºæ›¸ä¸Šçš„åå­—", statName: "æ†¤æ€’å€¼" },
        C: { name: "ç¶²å‹", statName: "ç‹‚ç†±å€¼" }
    };

    // å®Œæ•´çš„å¡ç‰‡è³‡æ–™èˆ‡é è¨­æ–‡å­—
    const storyData = {
        A: {
            1: { id: "A_1", text: "ã€Scene 1ï¼šæ•™å®¤çš„ä¸€è§’ã€‘\nä½ å‰›çµæŸè³‡æºç­çš„èª²ç¨‹å›åˆ°æ•™å®¤ã€‚ä½ æƒ³è·Ÿæ—é‚Šçš„åŒå­¸å€Ÿç­†ï¼Œä¹Ÿæƒ³è©¦è‘—èŠå¤©èå…¥å¤§å®¶ã€‚ä½ çš„æ‰‹å¿ƒå†’è‘—æ±—ï¼ŒçŒ¶è±«è©²æ€éº¼åš...", options: [{id:"A_1_A", text:"(A) å°è²èªªè©±", outcome:"A_1_A_Out"}, {id:"A_1_B", text:"(B) æ‹æ‹è‚©è†€", outcome:"A_1_B_Out"}] },
            2: { id: "A_2", text: "ã€Scene 2ï¼šç¶²è·¯ä¸Šçš„è€³èªã€‘\né‚£å¤©å›å®¶å¾Œï¼Œä½ ç™¼ç¾ç­ç´šç¾¤çµ„åœ¨å‚³ä¸€ç¯‡åŒ¿åçš„æ–‡ç« ï¼Œå½±å°„ä½ ä»¥å‰æƒ…ç·’å¤±æ§çš„æ¨£å­ã€‚", options: [{id:"A_2_A", text:"(A) é€ƒé¿", outcome:"A_2_A_Out"}, {id:"A_2_B", text:"(B) è¾¯è§£", outcome:"A_2_B_Out"}], trueOption: {id:"A_2_True", text:"ã€æ±‚åŠ©ã€‘æˆªåœ–ä¸¦å‘Šè¨´å¸«é•·", outcome:"A_2_True_Out"} },
            3: { id: "A_3", text: "ã€Scene 3ï¼šå´©æ½°ã€‘\né™Œç”Ÿç¶²å‹ç§è¨Šç½µä½ ï¼Œå«ä½ å»æ­»ã€‚ä½ çœ‹è‘—è¢å¹•ï¼Œè¦ºå¾—ä¸–ç•Œå®¹ä¸ä¸‹ä½ ã€‚ä½ æ‹¿èµ·äº†ç­†...", options: [{id:"A_3_Bad", text:"å¯«ä¸‹éºæ›¸...", outcome:"BadEnd"}] }
        },
        B: {
            1: { id: "B_1", text: "ã€Scene 1ï¼šæ·±å¤œçš„æˆ¿é–“ã€‘\næ·±å¤œç¡ä¸è‘—ï¼Œè…¦ä¸­æµ®ç¾å°å­¸æ™‚è¢«é‚£å€‹ç‰¹æ•™ç”Ÿæ¬ºè² çš„ç•«é¢ã€‚ææ‡¼å’Œå§”å±ˆå³ä¾¿é•·å¤§äº†é‚„æ˜¯å¾ˆæ¸…æ™°ã€‚", options: [{id:"B_1_A", text:"(A) å¯«æ—¥è¨˜", outcome:"B_1_A_Out"}, {id:"B_1_B", text:"(B) ç™¼IGé™å‹•", outcome:"B_1_B_Out"}] },
            2: { id: "B_2", text: "ã€Scene 2ï¼šå¤±æ§çš„è½‰ç™¼ã€‘\nä½ çš„æ–‡ç« è¢«è½‰ç™¼åˆ°å¤§ç¤¾åœ˜ï¼Œç¶²å‹é–‹å§‹è‚‰æœé‚£å€‹ç‰¹æ•™ç”Ÿã€‚äº‹æƒ…å¤±æ§äº†ã€‚", options: [{id:"B_2_A", text:"(A) é»˜ä¸ä½œè²", outcome:"B_2_A_Out"}, {id:"B_2_B", text:"(B) è·Ÿè‘—ç½µ", outcome:"B_2_B_Out"}], trueOption: {id:"B_2_True", text:"ã€ç•Œç·šã€‘ç™¼æ–‡åˆ¶æ­¢", outcome:"B_2_True_Out"} },
            3: { id: "B_3", text: "ã€Scene 3ï¼šæœ€å¾Œçš„æ±‚æ•‘ã€‘\nç‰¹æ•™ç”Ÿå‚³è¨Šçµ¦ä½ ï¼šã€Œå°ä¸èµ·ï¼Œè«‹ä½ å«ä»–å€‘åœæ­¢å¥½å—ï¼Ÿã€ä½ æŒ‰ä¸‹äº†å°é–ã€‚", options: [{id:"B_3_Bad", text:"çœ‹æ–°è...", outcome:"BadEnd"}] }
        },
        C: {
            1: { id: "C_1", text: "ã€Scene 1ï¼šç„¡èŠçš„æ»‘æ‰‹æ©Ÿã€‘\næ¼”ç®—æ³•æ¨çµ¦ä½ ä¸€ç¯‡é—œæ–¼éœ¸å‡Œçš„æ–‡ç« ã€‚å—å®³è€…æè¿°è‡ªå·±è¢«æ¬ºè² çš„éå»ã€‚", options: [{id:"C_1_A", text:"(A) æ»‘éå»", outcome:"C_1_A_Out"}, {id:"C_1_B", text:"(B) ç•™è¨€ã€Œå¤ªéåˆ†äº†ã€", outcome:"C_1_B_Out"}] },
            2: { id: "C_2", text: "ã€Scene 2ï¼šæ­£ç¾©çš„é›†çµã€‘\næœ‰äººè²¼å‡ºäº†ç–‘ä¼¼éœ¸å‡Œè€…çš„å¸³è™Ÿã€‚å¤§å®¶éƒ½åœ¨ä¸‹é¢ç•™è¨€ç½µä»–ã€‚", options: [{id:"C_2_A", text:"(A) è½‰ç™¼", outcome:"C_2_A_Out"}, {id:"C_2_B", text:"(B) ç§è¨Šç½µä»–", outcome:"C_2_B_Out"}], trueOption: {id:"C_2_True", text:"ã€æ€è€ƒã€‘åœä¸€ç§’", outcome:"C_2_True_Out"} },
            3: { id: "C_3", text: "ã€Scene 3ï¼šå…±çŠ¯ã€‘\né‚£å€‹å­¸ç”Ÿè‡ªæ®ºäº†ã€‚ä½ æ‰“é–‹ç§è¨Šï¼Œä¸Šé¢é¡¯ç¤ºã€Œå·²è®€ã€ã€‚", options: [{id:"C_3_Bad", text:"æŸ¥çœ‹...", outcome:"BadEnd"}] }
        }
    };

    // çµæœæ–‡æ¡ˆå°ç…§è¡¨
    const outcomeTexts = {
        "A_1_A_Out": "ä½ é¼“èµ·å‹‡æ°£èªªäº†è©±ï¼Œä½†è²éŸ³å¤ªå°ã€‚åŒå­¸ç›´æ¥èµ°æ‰ï¼Œç•™ä½ ä¸€å€‹äººåœ¨åŸåœ°ã€‚",
        "A_1_B_Out": "ä½ å¤ªç·Šå¼µäº†ï¼Œæ‰‹å‹å¤§äº†ä¸€é»ã€‚åŒå­¸åš‡å¾—è·³èµ·ä¾†å¤§å–Šï¼šã€Œä½ å¹¹å˜›æ‰“äººï¼ã€å…¨ç­éƒ½è½‰éä¾†çœ‹ä½ ã€‚",
        "A_2_A_Out": "ä½ ä»¥ç‚ºä¸ç†æœƒå°±æ²’äº‹ï¼Œä½†è¬ è¨€åƒç—…æ¯’ä¸€æ¨£æ“´æ•£ã€‚å¤§å®¶çœ‹ä½ çš„çœ¼ç¥å……æ»¿äº†ææ‡¼ã€‚",
        "A_2_B_Out": "ä½ ç„¦æ€¥åœ°è§£é‡‹ï¼Œä½†ä½ çš„æ–‡å­—è¢«æˆªåœ–ï¼ŒåŠ ä¸Šäº†å˜²ç¬‘çš„è²¼åœ–ï¼šã€Œçœ‹å§ï¼Œä»–é‚„åœ¨ç‹¡è¾¯ã€‚ã€",
        "A_2_True_Out": "é›–ç„¶å¾ˆå®³æ€•ï¼Œä½†ä½ å‘Šè¨´äº†åª½åª½å’Œè€å¸«ã€‚å¤§äººä»‹å…¥äº†ï¼Œä½ ä¸å†æ˜¯ä¸€å€‹äººé¢å°ã€‚",
        "B_1_A_Out": "å¯«å®Œé›–ç„¶èˆ’æœä¸€é»ï¼Œä½†çœ‹åˆ°ä»–éå¾—ä¸éŒ¯ï¼Œä½ å¿ƒè£¡çš„ä¸å¹³è¡¡æ„Ÿè¶Šä¾†è¶Šå¼·ã€‚",
        "B_1_B_Out": "æœ‹å‹ç´›ç´›å›è¦†æŒºä½ ã€‚ä½ è¦ºå¾—çµ‚æ–¼æœ‰äººæ‡‚ä½ äº†ï¼Œç²å¾—å·¨å¤§çš„æƒ…ç·’æ”¯æŒã€‚",
        "B_2_A_Out": "ä½ é¸æ“‡æ²‰é»˜ã€‚ç¶²å‹æŠŠä½ æ²‰é»˜ç•¶ä½œé»˜è¨±ï¼Œéœ¸å‡Œçš„åŠ›é“è¶Šä¾†è¶Šå¼·ã€‚",
        "B_2_B_Out": "ä½ è¦ºå¾—é€™æ˜¯æ­£ç¾©ã€‚ä½ çš„æ†¤æ€’æˆç‚ºäº†ç¶²å‹æ”»æ“Šä»–çš„ç‡ƒæ–™ã€‚",
        "B_2_True_Out": "ä½ ç™¼äº†ä¸€ç¯‡æ–°æ–‡åˆ¶æ­¢ç¶²å‹ï¼šã€Œæˆ‘æ˜¯å—å®³è€…ï¼Œä½†æˆ‘ä¸éœ€è¦ä½ å€‘ç”¨éœ¸å‡Œä¾†å¹«æˆ‘è¨å…¬é“ã€‚ã€",
        "C_1_A_Out": "ä½ é›–ç„¶æ»‘éå»äº†ï¼Œä½†æ¼”ç®—æ³•é–‹å§‹æ¨æ’­æ›´å¤šé¡ä¼¼çš„è² é¢æƒ…ç·’æ–‡ç« ï¼Œå¿ƒæƒ…è®Šå¾—ç…©èºã€‚",
        "C_1_B_Out": "ä½ çš„ç•™è¨€ç²å¾—å¾ˆå¤šè®šã€‚ä½ è¦ºå¾—è‡ªå·±å……æ»¿æ­£ç¾©æ„Ÿï¼Œç«™åœ¨å¼±å‹¢é€™é‚Šæ˜¯å°çš„ã€‚",
        "C_2_A_Out": "ä½ åˆ†äº«äº†è²¼æ–‡ï¼Œå‡è¨Šæ¯ç—…æ¯’å¼å‚³æ’­ã€‚ä½ æˆç‚ºäº†æ“´éŸ³å™¨ã€‚",
        "C_2_B_Out": "ä½ ç›´æ¥å‚³è¨Šæ”»æ“Šä»–ã€‚ä½ è¦ºå¾—ä½ åœ¨æ›¿å¤©è¡Œé“ï¼Œæ¯«ç„¡ç½ªæƒ¡æ„Ÿã€‚",
        "C_2_True_Out": "ä½ çœ‹è‘—è¢å¹•ï¼Œå•è‡ªå·±ï¼šã€Œæˆ‘çœ‹åˆ°çš„æ˜¯å…¨è²Œé‚„æ˜¯ç¢ç‰‡ï¼Ÿã€è¬ è¨€æ­¢æ–¼æ™ºè€…ã€‚",
        "BadEnd": "ã€æ‚²åŠ‡ç™¼ç”Ÿã€‘éºæ†¾çš„çµæœã€‚éœ€è¦æ™‚å…‰ä¿®å¾©ã€‚",
        "TrueEnd": "ã€ä¿®å¾©çµå±€ã€‘é›¨éå¤©æ™´ã€‚çµå±€æ”¹è®Šäº†ã€‚",
        "Rewind": "ã€æ™‚å…‰å€’æµã€‘ç³»çµ±é‡çµ„ä¸­..."
    };

    // --- å…¨åŸŸè®Šæ•¸ ---
    let gameState = { role: null, scene: 1, stats: 0, phase: 1, isBadEnd: false, isRewind: false, isTrueEnd: false };
    
    // --- LocalStorage ç®¡ç† ---
    const DB_KEY_IMGS = "time_mender_images";
    const DB_KEY_CONFIG = "time_mender_config";

    // è¼‰å…¥è¨­å®š
    function loadConfig() {
        const conf = localStorage.getItem(DB_KEY_CONFIG);
        return conf ? JSON.parse(conf) : { password: "0000" };
    }

    function saveConfig(config) {
        localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(config));
    }

    // è¼‰å…¥åœ–ç‰‡è³‡æ–™åº«
    function loadImages() {
        const imgs = localStorage.getItem(DB_KEY_IMGS);
        return imgs ? JSON.parse(imgs) : {};
    }

    function saveImage(id, base64) {
        const imgs = loadImages();
        imgs[id] = base64;
        try {
            localStorage.setItem(DB_KEY_IMGS, JSON.stringify(imgs));
            return true;
        } catch (e) {
            alert("åœ–ç‰‡ç©ºé–“å·²æ»¿ï¼è«‹å˜—è©¦æ¸…é™¤éƒ¨åˆ†åœ–ç‰‡æˆ–ä½¿ç”¨æ›´å°çš„åœ–ç‰‡ã€‚");
            return false;
        }
    }
    
    function clearImage(id) {
        const imgs = loadImages();
        delete imgs[id];
        localStorage.setItem(DB_KEY_IMGS, JSON.stringify(imgs));
        renderAdminSceneList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    }

    // --- åœ–ç‰‡å£“ç¸®é‚è¼¯ ---
    function compressImage(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // è¨­å®šæœ€å¤§å¯¬åº¦ 800px (å…¼é¡§ç•«è³ªèˆ‡å®¹é‡)
                const maxWidth = 800;
                const scaleSize = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scaleSize;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                // è½‰ç‚º JPEG 0.7 å“è³ª
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                callback(dataUrl);
            };
        };
    }

    // --- éŠæˆ²é‚è¼¯ ---
    const hud = document.getElementById('hud');
    const statName = document.getElementById('stat-name');
    const statBar = document.getElementById('stat-bar');
    const sceneImage = document.getElementById('scene-image');
    const storyText = document.getElementById('story-text');
    const choicesDiv = document.getElementById('choices');
    const body = document.body;

    function initGame() {
        showRoleSelection();
    }

    function getCustomImage(id) {
        const imgs = loadImages();
        return imgs[id] || null;
    }

    // åœ–ç‰‡è¼‰å…¥èˆ‡ Fallback
    function handleImageError(img) {
        let fallbackType = "normal";
        let fallbackEmoji = "ğŸ–¼ï¸";
        let fallbackText = "åœ–ç‰‡è¼‰å…¥ä¸­";

        if (gameState.isBadEnd) { fallbackType = "bad"; fallbackEmoji = "ğŸ’”"; fallbackText = "æ‚²åŠ‡ç™¼ç”Ÿ"; }
        else if (gameState.isRewind) { fallbackEmoji = "â³"; fallbackText = "æ™‚å…‰å€’æµ"; }
        else if (gameState.isTrueEnd) { fallbackEmoji = "ğŸŒˆ"; fallbackText = "ä¿®å¾©çµå±€"; }

        img.src = generateFallbackArt(fallbackEmoji, fallbackText, fallbackType);
        img.onerror = null;
    }

    // è¨­å®šåœ–ç‰‡ä¾†æº (å„ªå…ˆä½¿ç”¨ä¸Šå‚³çš„åœ–ç‰‡)
    function setSceneImage(id, defaultEmoji, defaultText, type="normal") {
        const custom = getCustomImage(id);
        if (custom) {
            sceneImage.src = custom;
        } else {
            sceneImage.src = generateFallbackArt(defaultEmoji, defaultText, type);
        }
        
        // å‹•ç•«é‡ç½®
        sceneImage.classList.remove('fade-in');
        void sceneImage.offsetWidth;
        sceneImage.classList.add('fade-in');
    }

    function showRoleSelection() {
        storyText.innerText = "ã€éºæ›¸ä¸Šçš„å››å€‹åå­—ã€‘\n\né€™æ˜¯ä¸€å€‹é—œæ–¼å¢œæ¨“æ¡ˆçš„æ•…äº‹ã€‚\nç¾å ´ç•™æœ‰ä¸€å°éºæ›¸ï¼Œä¸Šé¢å¯«è‘—å››å€‹åå­—ã€‚\n\nåœ¨æ•…äº‹é–‹å§‹å‰ï¼Œè«‹å•ä½ æ˜¯èª°ï¼Ÿ";
        choicesDiv.innerHTML = '';
        hud.style.display = 'none';
        sceneImage.style.display = 'none';
        body.className = ''; 
        storyText.classList.remove('epilogue-text');

        Object.keys(roles).forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'role-btn';
            btn.innerHTML = `<strong>æˆ‘æ˜¯ ${roles[key].name}</strong>`;
            btn.onclick = () => startGame(key);
            choicesDiv.appendChild(btn);
        });
    }

    function startGame(roleKey) {
        gameState.role = roleKey;
        gameState.scene = 1;
        gameState.stats = 0;
        gameState.phase = 1;
        gameState.isBadEnd = false;
        gameState.isRewind = false;
        gameState.isTrueEnd = false;

        hud.style.display = 'flex';
        sceneImage.style.display = 'block';
        statName.innerText = roles[roleKey].statName;
        updateStatBar(0);
        renderScene();
    }

    function updateStatBar(val) {
        statBar.style.width = val + '%';
        if (val < 40) statBar.style.background = 'linear-gradient(90deg, #a8e6cf, #88d8b0)';
        else if (val < 70) statBar.style.background = 'linear-gradient(90deg, #ffd3b6, #ffaaa5)';
        else statBar.style.background = 'linear-gradient(90deg, #ff8b94, #ff4b1f)';
    }

    function renderScene() {
        const rData = storyData[gameState.role];
        const sData = rData[gameState.scene];
        
        // è¨­å®šåœ–ç‰‡ ID
        const imgId = `${gameState.role}_${gameState.scene}`;
        setSceneImage(imgId, "ğŸ“–", `Scene ${gameState.scene}`);

        // æ–‡å­—
        document.getElementById('story-content').classList.remove('fade-in');
        void document.getElementById('story-content').offsetWidth;
        document.getElementById('story-content').classList.add('fade-in');

        let displayText = sData.text;
        if (gameState.phase === 2 && gameState.scene === 2) {
            displayText = sData.text.replace("ã€Scene 2ï¼š", "ã€Scene 2 (æ™‚å…‰å€’æµ)ï¼š");
            displayText += "\n\nä¸Šä¸€æ¬¡ï¼Œä½ çš„é¸æ“‡å°è‡´äº†æ‚²åŠ‡ã€‚é€™ä¸€æ¬¡ï¼Œä½ è¦æ€éº¼åšï¼Ÿ";
        }
        storyText.innerText = displayText;
        choicesDiv.innerHTML = '';

        if (sData.options) {
            sData.options.forEach((opt) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = opt.text;
                if (gameState.phase === 2 && opt.outcome !== "BadEnd") { // Phase 2 ç¦ç”¨æ™®é€šé¸é …
                    btn.classList.add('choice-disabled');
                } else {
                    btn.onclick = () => handleChoice(opt);
                }
                choicesDiv.appendChild(btn);
            });
        }

        if (gameState.phase === 2 && sData.trueOption) {
            const trueBtn = document.createElement('button');
            trueBtn.className = 'choice-btn choice-c';
            trueBtn.innerText = sData.trueOption.text;
            trueBtn.onclick = () => handleChoice(sData.trueOption);
            choicesDiv.appendChild(trueBtn);
        }
    }

    function handleChoice(option) {
        // è¨­å®šçµæœåœ–ç‰‡
        const outcomeId = option.outcome; // e.g., A_1_A_Out
        const displayText = outcomeTexts[outcomeId] || option.text;
        
        storyText.innerText = displayText;
        choicesDiv.innerHTML = ''; 
        
        if (outcomeId === "BadEnd") {
            triggerBadEnd();
            return;
        }

        // å˜—è©¦é¡¯ç¤ºçµæœåœ–
        setSceneImage(outcomeId, "ğŸ’¬", "é¸æ“‡çµæœ");

        // æ•¸å€¼å½±éŸ¿
        let statEffect = 20; 
        if (gameState.phase === 2) statEffect = -20; // ä¿®å¾©éšæ®µæ•¸å€¼ä¸‹é™
        else statEffect += (gameState.scene * 10);

        gameState.stats += statEffect;
        if (gameState.stats > 100) gameState.stats = 100;
        if (gameState.stats < 0) gameState.stats = 0;
        updateStatBar(gameState.stats);

        const nextBtn = document.createElement('button');
        nextBtn.innerText = "ç¹¼çºŒ...";
        nextBtn.style.textAlign = 'center';
        nextBtn.onclick = () => {
            if (outcomeId.includes("True")) triggerTrueEnd();
            else {
                gameState.scene += 1;
                if (gameState.scene > 3) triggerBadEnd(); // é˜²å‘†
                else renderScene();
            }
        };
        choicesDiv.appendChild(nextBtn);
    }

    function triggerBadEnd() {
        gameState.isBadEnd = true;
        body.className = 'bad-end-theme';
        
        setSceneImage("BadEnd", "ğŸ’”", "æ‚²åŠ‡ç™¼ç”Ÿ", "bad");
        
        let badEndText = "";
        if (gameState.role === 'A') badEndText = "ã€BAD ENDï¼šç„¡æ³•æŠ•éçš„é“æ­‰ã€‘\n\nä½ åœ¨ç´™ä¸Šå¯«æ»¿äº†ã€Œå°ä¸èµ·ã€ï¼Œä»¥åŠé‚£å››å€‹åå­—ã€‚\nä½ ä»¥ç‚ºé›¢é–‹å°±èƒ½è§£æ±ºç—›è‹¦ï¼Œä½†æ•…äº‹æ²’æœ‰å’Œè§£ï¼Œåªæœ‰ç„¡ç›¡çš„éºæ†¾ã€‚";
        else if (gameState.role === 'B') badEndText = "ã€BAD ENDï¼šç´™ä¸Šçš„åå­—ã€‘\n\næ–°èå ±å°ä»–å¢œæ¨“äº†ã€‚\né¡é ­æƒééºæ›¸ï¼Œä½ é©šæåœ°ç™¼ç¾ï¼Œ\néœ¸å‡Œè€…çš„åå–®ç¬¬ä¸€è¡Œï¼Œå°±æ˜¯ä½ çš„åå­—ã€‚\nå®¶é•·å“­å–Šï¼šã€Œæˆ‘çš„å­©å­æ˜¯å—å®³è€…ï¼Œæ€éº¼è®Šæˆå…‡æ‰‹ï¼Ÿã€";
        else badEndText = "ã€BAD ENDï¼šéµç›¤ä¸‹çš„å…‡æ‰‹ã€‘\n\nä»–åœ¨æ­»å‰ä¸€åˆ†é˜è®€äº†ä½ çš„è¨Šæ¯ã€‚\nä½ çš„æ­£ç¾©æ„Ÿï¼Œæˆç‚ºäº†æ¨ä»–ä¸‹å»çš„æœ€å¾Œä¸€éš»æ‰‹ã€‚\nä½ æ®ºäº†äººï¼Œé›–ç„¶æ³•å¾‹ç„¡æ³•åˆ¶è£ä½ ï¼Œä½†ä½ æ°¸é çŸ¥é“çœŸç›¸ã€‚";

        storyText.innerText = badEndText;
        choicesDiv.innerHTML = '';

        const rewindBtn = document.createElement('button');
        rewindBtn.innerHTML = "å•Ÿå‹•æ™‚å…‰ä¿®å¾© â³";
        rewindBtn.className = 'choice-btn';
        rewindBtn.style.marginTop = '20px';
        rewindBtn.style.background = '#fff';
        rewindBtn.style.color = '#333'; // ä¿®æ­£ï¼šè¨­å®šæ–‡å­—ç‚ºæ·±è‰²ï¼Œé¿å…ç™½åº•ç™½å­—
        rewindBtn.style.fontWeight = 'bold';
        rewindBtn.onclick = triggerTimeRewind;
        choicesDiv.appendChild(rewindBtn);
    }

    function triggerTimeRewind() {
        gameState.isBadEnd = false;
        gameState.isRewind = true;
        body.className = '';
        storyText.innerText = "ç³»çµ±åµæ¸¬åˆ°è‡´å‘½éŒ¯èª¤...\næ­£åœ¨é‡çµ„æ™‚é–“ç·š...\n\nå›åˆ°é—œéµåˆ†æ­§é»ã€‚";
        
        setSceneImage("Rewind", "â³", "æ™‚å…‰å€’æµ");
        
        gameState.stats = 30;
        updateStatBar(gameState.stats);
        
        gameState.phase = 2;
        gameState.scene = 2; // å›åˆ° Scene 2

        choicesDiv.innerHTML = '';
        setTimeout(() => {
            renderScene();
        }, 2500);
    }

    function triggerTrueEnd() {
        gameState.isTrueEnd = true;
        body.className = 'true-end-theme';
        
        setSceneImage("TrueEnd", "ğŸŒˆ", "ä¿®å¾©çµå±€", "good");

        storyText.innerText = "ã€TRUE ENDï¼šä¿®å¾©çš„èµ·é»ã€‘\n\né›–ç„¶å‚·ç—•æ²’æœ‰é¦¬ä¸Šæ¶ˆå¤±ï¼Œä½†ä½ åšå‡ºäº†ä¸ä¸€æ¨£çš„é¸æ“‡ã€‚\n\nçµå±€æ”¹è®Šäº†ã€‚æ²’æœ‰äººå¢œæ¨“ï¼Œæ²’æœ‰éºæ›¸ã€‚\nåªæœ‰é›–ç„¶è‰±é›£ï¼Œä½†è¸å¯¦çš„æœªä¾†ã€‚";
        
        updateStatBar(0);
        choicesDiv.innerHTML = '';
        
        const finishBtn = document.createElement('button');
        finishBtn.innerText = "æŸ¥çœ‹æ•™è‚²çœæ€";
        finishBtn.className = 'role-btn';
        finishBtn.onclick = showEpilogue;
        choicesDiv.appendChild(finishBtn);
    }

    function showEpilogue() {
        sceneImage.style.display = 'none';
        storyText.classList.add('epilogue-text');
        storyText.innerHTML = `
            <h3>ã€çµ¦æ™‚å…‰ä¿®å¾©å¸«çš„ä¸€å°ä¿¡ã€‘</h3>
            <br>
            åœ¨éŠæˆ²è£¡ï¼Œæˆ‘å€‘æœ‰æ©ŸæœƒæŒ‰ä¸‹é‡ä¾†éµã€‚<br>
            ä½†åœ¨ç¾å¯¦çš„ç”Ÿå‘½è£¡ï¼Œå‚·å®³ä¸€æ—¦é€ æˆï¼Œå¾€å¾€ç„¡æ³•å®Œå…¨å¾©åŸã€‚<br>
            <br>
            çœŸæ­£çš„ä¿®å¾©ï¼Œä¸æ˜¯ç­‰å¾…æ‚²åŠ‡ç™¼ç”Ÿå¾Œæ‰å¾Œæ‚”ï¼Œ<br>
            è€Œæ˜¯åœ¨æ¯ä¸€å€‹é¸æ“‡çš„ç•¶ä¸‹ï¼š<br>
            <br>
            å¤šä¸€ä»½ <span class="highlight">æ±‚åŠ©çš„å‹‡æ°£</span><br>
            å¤šä¸€ä»½ <span class="highlight">æƒ…ç·’çš„ç•Œç·š</span><br>
            å¤šä¸€ç§’ <span class="highlight">æš«åœçš„æ€è€ƒ</span><br>
            <br>
            é¡˜æˆ‘å€‘éƒ½ä¸è¦æˆç‚ºé‚£ç„¡æ„åŠ é‡ä»–äººç—›è‹¦ä¸­ï¼Œ<br>
            ã€Œç´™ä¸Šçš„åå­—ã€ã€‚
        `;
        choicesDiv.innerHTML = '';
        
        const restartBtn = document.createElement('button');
        restartBtn.innerText = "å›åˆ°é¦–é ";
        restartBtn.onclick = () => location.reload();
        choicesDiv.appendChild(restartBtn);
    }

    // --- Admin Panel Logic ---
    const adminPanel = document.getElementById('admin-panel');
    const loginModal = document.getElementById('login-modal');
    const currentPassDisplay = document.getElementById('current-pass-display');
    const sceneList = document.getElementById('scene-list');

    function openLoginModal() { loginModal.style.display = 'flex'; }
    function closeLoginModal() { loginModal.style.display = 'none'; document.getElementById('login-msg').innerText = ''; }
    
    function checkLogin() {
        const input = document.getElementById('login-password').value;
        const conf = loadConfig();
        if (input === conf.password) {
            closeLoginModal();
            openAdminPanel();
        } else {
            document.getElementById('login-msg').innerText = "å¯†ç¢¼éŒ¯èª¤";
        }
    }

    function openAdminPanel() {
        adminPanel.style.display = 'block';
        updateAdminUI();
        renderAdminSceneList();
    }

    function closeAdminPanel() { adminPanel.style.display = 'none'; location.reload(); }

    function updateAdminUI() {
        const conf = loadConfig();
        currentPassDisplay.innerText = conf.password;
    }

    function changePassword() {
        const newPass = document.getElementById('new-password').value;
        if (!newPass) return alert("è«‹è¼¸å…¥æ–°å¯†ç¢¼");
        const conf = loadConfig();
        conf.password = newPass;
        saveConfig(conf);
        updateAdminUI();
        alert("å¯†ç¢¼å·²æ›´æ”¹ç‚º: " + newPass);
        document.getElementById('new-password').value = "";
    }

    function resetPassword() {
        if (!confirm("ç¢ºå®šè¦é‡ç½®å¯†ç¢¼ç‚º 0000 å—ï¼Ÿ")) return;
        const conf = loadConfig();
        conf.password = "0000";
        saveConfig(conf);
        updateAdminUI();
        alert("å¯†ç¢¼å·²é‡ç½®");
    }

    // æ¸²æŸ“ç®¡ç†åˆ—è¡¨
    function renderAdminSceneList() {
        sceneList.innerHTML = '';
        const allIds = [];

        // æ”¶é›†æ‰€æœ‰éœ€è¦åœ–ç‰‡çš„ ID
        Object.keys(storyData).forEach(role => {
            Object.keys(storyData[role]).forEach(scene => {
                const sData = storyData[role][scene];
                // å ´æ™¯åœ–
                allIds.push({id: `${role}_${scene}`, desc: `[${roles[role].name}] Scene ${scene}`, text: sData.text});
                // é¸é …çµæœåœ–
                sData.options.forEach(opt => {
                    allIds.push({id: opt.outcome, desc: `[${roles[role].name}] S${scene} é¸é …: ${opt.text}`, text: outcomeTexts[opt.outcome] || "ç„¡å°æ‡‰æ–‡æ¡ˆ"});
                });
                // True Option çµæœåœ–
                if (sData.trueOption) {
                    allIds.push({id: sData.trueOption.outcome, desc: `[${roles[role].name}] S${scene} æ­£ç¢ºé¸é …`, text: outcomeTexts[sData.trueOption.outcome]});
                }
            });
        });

        // å…±é€šçµå±€åœ–
        allIds.push({id: "BadEnd", desc: "[çµå±€] æ‚²åŠ‡ç™¼ç”Ÿ", text: outcomeTexts["BadEnd"]});
        allIds.push({id: "Rewind", desc: "[ç‰¹æ•ˆ] æ™‚å…‰å€’æµ", text: outcomeTexts["Rewind"]});
        allIds.push({id: "TrueEnd", desc: "[çµå±€] ä¿®å¾©çµå±€", text: outcomeTexts["TrueEnd"]});

        // ç”Ÿæˆ HTML
        allIds.forEach(item => {
            if (!item.id || item.id === "BadEnd" && item.desc.includes("S3")) return; // éæ¿¾æ‰é‡è¤‡çš„ BadEnd

            const customImg = getCustomImage(item.id);
            const imgSrc = customImg || generateFallbackArt("ğŸ–¼ï¸", "é è¨­åœ–ç‰‡");
            const statusColor = customImg ? "#28a745" : "#ccc";
            const statusText = customImg ? "âœ… å·²ä¸Šå‚³" : "âšª ä½¿ç”¨é è¨­";

            const div = document.createElement('div');
            div.className = "scene-card";
            div.innerHTML = `
                <div>
                    <img src="${imgSrc}" class="scene-preview">
                    <div style="text-align:center; margin-top:5px; color:${statusColor}; font-size:0.8rem; font-weight:bold;">${statusText}</div>
                </div>
                <div class="scene-info">
                    <h4>${item.desc} (ID: ${item.id})</h4>
                    
                    <div class="file-upload-wrapper">
                        <button class="admin-btn" onclick="document.getElementById('file-${item.id}').click()">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</button>
                        ${customImg ? `<button class="admin-btn danger" onclick="clearImage('${item.id}')">ğŸ—‘ï¸ æ¸…é™¤</button>` : ''}
                        <input type="file" id="file-${item.id}" style="display:none" accept="image/*" onchange="handleAdminUpload('${item.id}', this)">
                    </div>

                    <div class="scene-text">
                        <strong>æ–‡æ¡ˆå…§å®¹ç¢ºèªï¼š</strong><br>
                        ${item.text}
                    </div>
                </div>
            `;
            sceneList.appendChild(div);
        });
    }

    function handleAdminUpload(id, input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            compressImage(file, (base64) => {
                if(saveImage(id, base64)) {
                    renderAdminSceneList();
                }
            });
        }
    }

    // åŒ¯å‡ºè³‡æ–™
    function exportData() {
        const data = {
            config: loadConfig(),
            images: loadImages()
        };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "time_mender_backup.json";
        a.click();
    }

    // åŒ¯å…¥è³‡æ–™
    function importData(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.config && data.images) {
                        saveConfig(data.config);
                        localStorage.setItem(DB_KEY_IMGS, JSON.stringify(data.images));
                        alert("åŒ¯å…¥æˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚");
                        location.reload();
                    } else {
                        alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                    }
                } catch (err) {
                    alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆææ¯€");
                }
            };
            reader.readAsText(input.files[0]);
        }
    }

    // å•Ÿå‹•éŠæˆ²
    initGame();

</script>

</body>
</html>